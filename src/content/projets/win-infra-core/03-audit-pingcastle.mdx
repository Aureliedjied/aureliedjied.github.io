---
title: "Audit PingCastle"
description: "Audit du domaine et durcissement via GPO selon recommandations ANSSI."
category: "windows"
tags: ["Windows Server", "Installation", "S√©curit√©", "Active Directory"]
pubDate: 2026-01-15
slug: "audit-pingcastle"
---
import SeriesStepper from '../../../components/SeriesStepper.astro';
import { WIN_INFRA_CORE } from '../../../constants/series';
import NextStep from '../../../components/NextStep.astro';

<SeriesStepper 
  seriesTitle="Auditer la s√©curit√©" 
  steps={WIN_INFRA_CORE} 
  currentStepIndex={3} 
/>

Apr√®s avoir promu notre domaine et configur√© les services de base, il est crucial de confronter l'installation √† la r√©alit√© de la cybers√©curit√©. Pour cela, j'utilise **PingCastle**, un outil d'audit sp√©cialis√© dans l'√©valuation du niveau de risque des infrastructures Active Directory.

### Lancement de l'audit

L'outil ne n√©cessite pas d'installation complexe : dans un environnement de production, l‚Äôoutil devrait √™tre ex√©cut√© depuis un poste d‚Äôadministration s√©curis√© (PAW). Dans ce lab, il est ex√©cut√© directement sur le DC √† des fins p√©dagogiques.. Ce premier scan sert de **"Baseline"** (point de r√©f√©rence) pour identifier les vuln√©rabilit√©s par d√©faut de Windows Server.

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-8">
  <div class="flex flex-col items-center">
    <img src="/images/projets/win-infra-core/audit/choix-install.png" alt="Choix mode" class="rounded-lg border border-white/10 shadow-md w-full" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">S√©lection du mode Healthcheck.</p>
  </div>
  <div class="flex flex-col items-center">
    <img src="/images/projets/win-infra-core/audit/pingcastle-exe.png" alt="Lancement exe" class="rounded-lg border border-white/10 shadow-md w-full" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Ex√©cution en tant qu'administrateur.</p>
  </div>
</div>

### √âtat des lieux

Le premier rapport g√©n√©r√© sert de point de r√©f√©rence. Avec un **Risk Score global de 60/100**, l'infrastructure pr√©sente des vuln√©rabilit√©s h√©rit√©es des configurations par d√©faut de Windows Server.

<div class="grid grid-cols-1 md:grid-cols-2 gap-8 my-8 items-center">
  <div class="flex flex-col items-center">
     <img src="/images/projets/win-infra-core/audit/pingcastle-radar.png" alt="Radar de s√©curit√©" class="rounded-lg border border-white/10 shadow-md w-full max-w-[300px]" />
     <p class="text-[0.65rem] italic opacity-50 mt-2">R√©partition du risque initial.</p>
  </div>
  
  <div>
| Indicateur | Score |  | Commentaire |
| :--- | :--- | :--- | :--- |
| **Anomalies** | <span style="color:#ef4444">60</span> | üü† Critique | Protocoles obsol√®tes (NTLMv1) et DNS permissif. |
| **Privileged Accounts** | <span style="color:#f97316">40</span> | üü† Important | Besoin de durcissement des comptes admins. |
| **Stale Objects** | <span style="color:#eab308">31</span> | üü° Moyen | Objets inactifs √† nettoyer dans l'annuaire. |
| **Trusts** | <span style="color:#22c55e">0</span> | üü¢ Sain | Aucune relation d'approbation externe. |
  </div>
</div>

---

## üõ†Ô∏è Phase de Hardening (Durcissement par GPO)

Le durcissement (Hardening) a √©t√© r√©alis√© principalement via des **GPO (Group Policy Objects)**. Une GPO permet de centraliser et d'automatiser l'application de r√®gles de s√©curit√© sur l'ensemble du domaine. 

Pour maintenir une infrastructure lisible, j'ai adopt√© une nomenclature stricte : `[CIBLE]-[ACTION]-[DESCRIPTION]`. J'ai choisi de cr√©er des GPO d√©di√©es plut√¥t que de modifier les politiques par d√©faut (`Default Domain Policy`), permettant un meilleur contr√¥le et un retour arri√®re facilit√©.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/risk-model.png" alt="Risques √† am√©liorer" class="max-w-[600px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Le Risk Model d√©taille les points de contr√¥le √† durcir en priorit√©.</p>
  </div>
</div>


### 1. D√©sactivation du NTLMv1
**GPO associ√©e :** `DOM-H-Hardening_Protocols`

Le domaine autorisait encore le protocole obsol√®te NTLMv1, vuln√©rable aux attaques par relais. Selon la **recommandation ANSSI n¬∞12**, j'ai forc√© le niveau d'authentification sur "**NTLMv2 uniquement**" via la politique de groupe racine.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/gpo-ntlm.png" alt="D√©sactivation ntlm" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">For√ßage de NTLMv2 et refus du LM/NTLMv1.</p>
  </div>
</div>


### 2. D√©sactivation LLMNR
**GPO associ√©e :** `DOM-H-Hardening_Protocols`

LLMNR est un protocole de r√©solution de noms local qui peut √™tre d√©tourn√© pour capturer des hashs de mots de passe. Le DNS sera fonctionnel sur notre domaine, ce protocole est donc inutile et dangereux ; il est d√©sactiv√© par GPO.

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-8">
  <div class="flex flex-col items-center">
    <img src="/images/projets/win-infra-core/audit/llmnr1.png" alt="llmnr1" class="rounded-lg border border-white/10 shadow-md w-full" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Localisation du param√®tre de r√©solution multicast.</p>
  </div>
  <div class="flex flex-col items-center">
    <img src="/images/projets/win-infra-core/audit/llmnr2.png" alt="llmnr2" class="rounded-lg border border-white/10 shadow-md w-full" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Activation de la restriction LLMNR.</p>
  </div>
</div>


### 3. Visibilit√© sur l'activit√© PowerShell
**GPO associ√©e :** `DOM-S-PowerShell_Auditing`

L'activation de l'audit PowerShell (Script Block Logging) permet de tracer l'ex√©cution de commandes malveillantes, m√™me si elles sont obfusqu√©es, garantissant une meilleure r√©ponse aux incidents.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/actived-powershell.png" alt="Audit PowerShell" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Mise en place de la tra√ßabilit√© des scripts PowerShell.</p>
  </div>
</div>


### 4. D√©sactivation du Spooler d'impression
**GPO associ√©e :** `DC-H-Services_Restriction`

Le service de spouleur sur un contr√¥leur de domaine pr√©sente un risque majeur (faille PrintNightmare). Ce service est d√©sactiv√© car il est inutile sur un serveur d'infrastructure.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/spooler-desactived.png" alt="Spooler d√©sactiv√©" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Arr√™t et d√©sactivation du service de spouleur syst√®me.</p>
  </div>
</div>


### 5. Activation de l'Audit Avanc√©  
**GPO associ√©e :** `DOM-S-Advanced_Auditing`

L‚Äôaudit natif de Windows √©tant trop limit√© pour une analyse de s√©curit√© pertinente, j‚Äôai d√©ploy√© une GPO d√©di√©e √† la **strat√©gie d‚Äôaudit avanc√©e**. Cette configuration permet une journalisation fine des actions sensibles r√©alis√©es dans l‚Äôannuaire et sur les contr√¥leurs de domaine.

Les cat√©gories suivantes ont √©t√© activ√©es en **Succ√®s et √âchec** :

- **Gestion des comptes** : suivi des cr√©ations, suppressions et modifications d‚Äôutilisateurs et de groupes  
- **Ouverture et fermeture de session** : tra√ßabilit√© des connexions interactives, r√©seau et RDP  
- **Acc√®s au service d‚Äôannuaire** : d√©tection des lectures et modifications d‚Äôobjets Active Directory  
- **Modification de strat√©gie** : d√©tection de tout changement sur les politiques de s√©curit√© ou d‚Äôaudit  

Cette granularit√© est indispensable pour d√©tecter :
- l‚Äôutilisation anormale de comptes privil√©gi√©s  
- les tentatives d‚Äô√©l√©vation de privil√®ges  
- les modifications suspectes dans l‚Äôannuaire  

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-8">
  <div class="flex flex-col items-center">
    <img src="/images/projets/win-infra-core/audit/audit-comptes.png" alt="Audit gestion comptes" class="rounded-lg border border-white/10 shadow-md w-full" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Tra√ßabilit√© des modifications sur les utilisateurs et groupes.</p>
  </div>
  <div class="flex flex-col items-center">
    <img src="/images/projets/win-infra-core/audit/audit-sessions.png" alt="Audit sessions" class="rounded-lg border border-white/10 shadow-md w-full" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Surveillance des ouvertures et fermetures de sessions.</p>
  </div>
</div>

Afin d‚Äôassurer la coh√©rence de la configuration, j‚Äôai √©galement activ√© l‚Äôoption :

**‚ÄúForcer les sous-cat√©gories de strat√©gie d‚Äôaudit √† remplacer les cat√©gories de strat√©gie d‚Äôaudit‚Äù**

Cela garantit que la strat√©gie d‚Äôaudit avanc√©e d√©finie par GPO pr√©vaut sur toute configuration locale.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/audit-global.png" alt="Option de remplacement des cat√©gories d'audit" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Forcer la configuration de l'audit par la GPO</p>
  </div>
</div>


## Protection des objets et des identit√©s (Protected Users)

La s√©curit√© d'un domaine ne repose pas uniquement sur les GPO, mais aussi sur la gestion rigoureuse des objets critiques de l'Active Directory.

#### **Le bouclier "Protected Users**"
J'ai int√©gr√© mes comptes d'administration nominatifs au groupe de s√©curit√© **Protected Users**. Selon l'ANSSI, ce groupe est une protection indispensable :
* Il d√©sactive les protocoles d'authentification faibles (NTLM).
* Il emp√™che la mise en cache des identifiants sur les postes de travail.
* Il limite la dur√©e de vie des tickets Kerberos.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/protected-users.png" alt="Membres du groupe Protected Users" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Ajout de l'administrateur nominatif dans le groupe Protected Users.</p>
  </div>
</div>

## S√©curisation des zones DNS
Par d√©faut, le groupe `Utilisateurs authentifi√©s` dispose du droit de cr√©ation d'objets enfants dans la zone DNS. Cette configuration par d√©faut expose le domaine √† des risques de pollution d'annuaire ou d'usurpation d'identit√© r√©seau. 

J'ai donc modifi√© les **ACL (Access Control Lists)** de la zone DNS pour retirer les utilisateurs non-privil√©gi√©s, ne laissant que les serveurs et les administrateurs g√©rer les enregistrements.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/dns-security.png" alt="S√©curit√© DNS" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Suppression des Utilisateurs Authentifi√©s.</p>
  </div>
</div>

## Pr√©vention des erreurs de manipulation
Afin de garantir la disponibilit√© du domaine, j'ai activ√© la **protection contre la suppression accidentelle** sur les Unit√©s d'Organisation (OU) strat√©giques, notamment l'OU des contr√¥leurs de domaine. Cette mesure emp√™che toute suppression involontaire qui pourrait entra√Æner un arr√™t de service majeur.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/protected-ou.png" alt="ou non supprimables" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Emp√™cher la suppression accidentelle d'une OU.</p>
  </div>
</div>

## Restriction du privil√®ge de jonction via Powershell (ms-DS-MachineAccountQuota)
Par d√©faut, n'importe quel utilisateur peut joindre 10 machines au domaine. C'est un risque majeur de d√©ni de service et d'usurpation. J'ai modifi√© cet attribut pour ramener le quota √† **0**, verrouillant ainsi la cr√©ation sauvage de comptes ordinateurs.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/ms-ds-desactived.png" alt="D√©sactivation quota machine" class="max-w-[400px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Modification de l'attribut ms-DS-MachineAccountQuota pour interdire la jonction automatique.</p>
  </div>
</div>


## üåê Optimisation de l'infrastructure et r√©seau

Pour parfaire l'audit, j'ai corrig√© deux alertes structurelles relev√©es par l'outil qui impactaient la "propret√©" de l'annuaire et la s√©curit√© des flux.

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-8">
  <div class="bg-white/5 p-4 rounded-lg border border-white/10">
    <h4 class="text-primary mt-0 flex items-center gap-2">
      üìç Sites et Services AD
    </h4>
    <p class="text-sm">
      D√©claration du sous-r√©seau IP (Subnet) li√© au site <code>Default-First-Site-Name</code>. Cela permet √† l'AD de mapper correctement l'infra et d'optimiser les r√©plications.
    </p>
  </div>

  <div class="bg-white/5 p-4 rounded-lg border border-white/10">
    <h4 class="text-primary mt-0 flex items-center gap-2">
      üî• Filtrage PowerShell
    </h4>
    <p class="text-sm">
      Cr√©ation d'une r√®gle de pare-feu sortante bloquant <code>powershell.exe</code>. Mesure exp√©rimentale en environnement de lab visant √† limiter les exfiltrations simples via PowerShell pour emp√™cher le t√©l√©chargement de payloads malveillants depuis l'ext√©rieur.
    </p>
  </div>
</div>


## ‚úÖ Validation : Nouveau Scan de S√©curit√©

Apr√®s l‚Äôapplication des mesures de durcissement, un second audit PingCastle a √©t√© r√©alis√© afin de mesurer objectivement l‚Äôimpact des corrections.

Ce nouveau scan montre une **r√©duction significative du niveau de risque**, notamment sur les cat√©gories li√©es aux protocoles obsol√®tes et aux mauvaises pratiques par d√©faut.

Les am√©liorations principales concernent :
- la disparition de NTLMv1  
- la restriction du quota de cr√©ation de machines  
- la r√©duction de la surface d‚Äôattaque li√©e aux services inutiles  
- une meilleure tra√ßabilit√© des actions sensibles gr√¢ce √† l‚Äôaudit avanc√©  

<div class="grid grid-cols-1 md:grid-cols-2 gap-8 my-8 items-center">
  <div class="flex flex-col items-center">
     <img src="/images/projets/win-infra-core/audit/pingcastle-radar2.png" alt="Radar de s√©curit√© apr√®s rem√©diation" class="rounded-lg border border-white/10 shadow-md w-full max-w-[300px]" />
     <p class="text-[0.65rem] italic opacity-50 mt-2">Radar de s√©curit√© apr√®s application des mesures de durcissement.</p>
  </div>
  
  <div class="flex flex-col items-center">
     <img src="/images/projets/win-infra-core/audit/risk-model2.png" alt="Risk model apr√®s rem√©diation" class="rounded-lg border border-white/10 shadow-md w-full max-w-[300px]" />
     <p class="text-[0.65rem] italic opacity-50 mt-2">D√©tail des indicateurs de risque restants apr√®s corrections.</p>
  </div>
</div>

Ce second rapport ne marque pas la fin du travail : il met en √©vidence les **axes d‚Äôam√©lioration restants**, qui seront trait√©s dans les prochaines √©tapes du projet, notamment :
- la mise en place de LAPS pour la gestion des mots de passe locaux  
- le d√©ploiement d‚Äôune autorit√© de certification interne (AD CS)  
- le renforcement de l‚Äôauthentification des comptes privil√©gi√©s ( MFA)

La s√©curit√© d‚Äôun Active Directory s‚Äôinscrit dans une d√©marche continue d‚Äôam√©lioration, bas√©e sur la mesure r√©guli√®re du risque et l‚Äôapplication progressive des recommandations.

<NextStep 
  href="/projets/ad-cs" 
  title="Installation de l‚ÄôAutorit√© de Certification (AD CS)" 
/>