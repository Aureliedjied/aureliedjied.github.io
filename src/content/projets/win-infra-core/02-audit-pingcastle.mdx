---
title: "Audit PingCastle"
description: "Audit du domaine et durcissement via GPO selon recommandations ANSSI."
tags: ["Windows", "Installation", "R√©seau", "S√©curit√©", "Active Directory"]
pubDate: 2026-01-15
slug: "audit-pingcastle"
---
import SeriesStepper from '../../../components/SeriesStepper.astro';
import { WIN_INFRA_CORE } from '../../../constants/series';
import NextStep from '../../../components/NextStep.astro';

<SeriesStepper 
  seriesTitle="Auditer la s√©curit√©" 
  steps={WIN_INFRA_CORE} 
  currentStepIndex={2} 
/>

# Audit de S√©curit√© avec PingCastle

Apr√®s avoir promu notre domaine et configur√© les services de base, il est crucial de confronter l'installation √† la r√©alit√© de la cybers√©curit√©. Pour cela, j'utilise **PingCastle**, un outil d'audit sp√©cialis√© dans l'√©valuation du niveau de risque des infrastructures Active Directory.

### Lancement de l'audit

L'outil ne n√©cessite pas d'installation complexe : il s'ex√©cute directement sur le Contr√¥leur de Domaine. Ce premier scan sert de **"Baseline"** (point de r√©f√©rence) pour identifier les vuln√©rabilit√©s par d√©faut de Windows Server.

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-8">
  <div class="flex flex-col items-center">
    <img src="/images/projets/win-infra-core/audit/choix-install.png" alt="Choix mode" class="rounded-lg border border-white/10 shadow-md w-full" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">S√©lection du mode Healthcheck.</p>
  </div>
  <div class="flex flex-col items-center">
    <img src="/images/projets/win-infra-core/audit/pingcastle-exe.png" alt="Lancement exe" class="rounded-lg border border-white/10 shadow-md w-full" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Ex√©cution en tant qu'administrateur.</p>
  </div>
</div>

### √âtat des lieux

Le premier rapport g√©n√©r√© sert de point de r√©f√©rence. Avec un **Risk Score global de 60/100**, l'infrastructure pr√©sente des vuln√©rabilit√©s h√©rit√©es des configurations par d√©faut de Windows Server.

<div class="grid grid-cols-1 md:grid-cols-2 gap-8 my-8 items-center">
  <div class="flex flex-col items-center">
     <img src="/images/projets/win-infra-core/audit/pingcastle-radar.png" alt="Radar de s√©curit√©" class="rounded-lg border border-white/10 shadow-md w-full max-w-[300px]" />
     <p class="text-[0.65rem] italic opacity-50 mt-2">R√©partition du risque initial.</p>
  </div>
  
  <div>
    | Indicateur | Score | Analyse |
    | :--- | :--- | :--- |
    | **Anomalies** | 60 | Protocoles obsol√®tes (NTLMv1) et DNS permissif. |
    | **Privileged Accounts** | 40 | Besoin de durcissement des comptes admins. |
    | **Stale Objects** | 31 | Objets inactifs √† nettoyer dans l'annuaire. |
    | **Trusts** | 0 | Aucune relation d'approbation externe. |
  </div>
</div>

---

## üõ†Ô∏è Phase de Hardening (Durcissement par GPO)

Le durcissement (Hardening) a √©t√© r√©alis√© principalement via des **GPO (Group Policy Objects)**. Une GPO permet de centraliser et d'automatiser l'application de r√®gles de s√©curit√© sur l'ensemble du domaine. 

Pour maintenir une infrastructure lisible, j'ai adopt√© une nomenclature stricte : `[CIBLE]-[ACTION]-[DESCRIPTION]`. J'ai choisi de cr√©er des GPO d√©di√©es plut√¥t que de modifier les politiques par d√©faut (`Default Domain Policy`), permettant un meilleur contr√¥le et un retour arri√®re facilit√©.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/risk-model.png" alt="Risques √† am√©liorer" class="max-w-[600px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Le Risk Model d√©taille les points de contr√¥le √† durcir en priorit√©.</p>
  </div>
</div>


### 1. D√©sactivation du NTLMv1
**GPO associ√©e :** `DOM-H-Protocols`

Le domaine autorisait encore le protocole obsol√®te NTLMv1, vuln√©rable aux attaques par relais. Selon la **recommandation ANSSI n¬∞12**, j'ai forc√© le niveau d'authentification sur "**NTLMv2 uniquement**" via la politique de groupe racine.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/gpo-ntlm.png" alt="D√©sactivation ntlm" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">For√ßage de NTLMv2 et refus du LM/NTLMv1.</p>
  </div>
</div>


### 2. D√©sactivation LLMNR
**GPO associ√©e :** `DOM-H-Protocols`

LLMNR est un protocole de r√©solution de noms local qui peut √™tre d√©tourn√© pour capturer des hashs de mots de passe. DNS √©tant fonctionnel sur notre domaine, ce protocole est inutile et dangereux ; il est donc d√©sactiv√© par GPO.

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-8">
  <div class="flex flex-col items-center">
    <img src="/images/projets/win-infra-core/audit/llmnr1.png" alt="llmnr1" class="rounded-lg border border-white/10 shadow-md w-full" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Localisation du param√®tre de r√©solution multicast.</p>
  </div>
  <div class="flex flex-col items-center">
    <img src="/images/projets/win-infra-core/audit/llmnr2.png" alt="llmnr2" class="rounded-lg border border-white/10 shadow-md w-full" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Activation de la restriction LLMNR.</p>
  </div>
</div>


### 3. Visibilit√© sur l'activit√© PowerShell
**GPO associ√©e :** `DOM-S-PowerShell_Auditing`

L'activation de l'audit PowerShell (Script Block Logging) permet de tracer l'ex√©cution de commandes malveillantes, m√™me si elles sont obfusqu√©es, garantissant une meilleure r√©ponse aux incidents.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/actived-powershell.png" alt="Audit PowerShell" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Mise en place de la tra√ßabilit√© des scripts PowerShell.</p>
  </div>
</div>


### 4. D√©sactivation du Spooler d'impression
**GPO associ√©e :** `DC-H-Services_Restriction`

Le service de spouleur sur un contr√¥leur de domaine pr√©sente un risque majeur (faille PrintNightmare). Ce service est d√©sactiv√© car il est inutile sur un serveur d'infrastructure.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/spooler-desactived.png" alt="Spooler d√©sactiv√©" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Arr√™t et d√©sactivation du service de spouleur syst√®me.</p>
  </div>
</div>


### 5. Activation de l'Audit Avanc√©
**GPO associ√©e :** `DOM-S-Advanced_Auditing`

L'audit de base √©tant trop limit√©, j'ai cr√©√©e une GPO sp√©cifique √† l'audit avanc√©. Cette granularit√© est indispensable pour identifier pr√©cis√©ment les modifications de l'annuaire ou les tentatives de connexions suspectes.

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-8">
  <div class="flex flex-col items-center">
    <img src="/images/projets/win-infra-core/audit/audit-comptes.png" alt="Audit gestion comptes" class="rounded-lg border border-white/10 shadow-md w-full" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Tra√ßabilit√© des modifications sur les utilisateurs et groupes.</p>
  </div>
  <div class="flex flex-col items-center">
    <img src="/images/projets/win-infra-core/audit/audit-sessions.png" alt="Audit sessions" class="rounded-lg border border-white/10 shadow-md w-full" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Surveillance des ouvertures et fermetures de sessions.</p>
  </div>
</div>

J'ai √©galement activ√© l'audit de l'**Acc√®s au service d'annuaire** et forc√© l'√©crasement des anciennes cat√©gories d'audit via les options de s√©curit√© des GPO.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/audit-global.png" alt="??" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Forcer la configuration de l'audit par la GPO</p>
  </div>
</div>


## Protection des objets et des identit√©s (Protected Users)

La s√©curit√© d'un domaine ne repose pas uniquement sur les GPO, mais aussi sur la gestion rigoureuse des objets critiques de l'Active Directory.

#### **Le bouclier "Protected Users**"
J'ai int√©gr√© mes comptes d'administration nominatifs au groupe de s√©curit√© **Protected Users**. Selon l'ANSSI, ce groupe est une protection indispensable :
* Il d√©sactive les protocoles d'authentification faibles (NTLM).
* Il emp√™che la mise en cache des identifiants sur les postes de travail.
* Il limite la dur√©e de vie des tickets Kerberos.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/protected-users.png" alt="Membres du groupe Protected Users" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Ajout de l'administrateur nominatif dans le groupe Protected Users.</p>
  </div>
</div>

## S√©curisation des zones DNS
Par d√©faut, le groupe `Utilisateurs authentifi√©s` dispose du droit de cr√©ation d'objets enfants dans la zone DNS. Cette configuration par d√©faut expose le domaine √† des risques de pollution d'annuaire ou d'usurpation d'identit√© r√©seau. 

J'ai donc modifi√© les **ACL (Access Control Lists)** de la zone DNS pour retirer les utilisateurs non-privil√©gi√©s, ne laissant que les serveurs et les administrateurs g√©rer les enregistrements.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/dns-security.png" alt="S√©curit√© DNS" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Suppression des Utilisateurs Authentifi√©s.</p>
  </div>
</div>

## Pr√©vention des erreurs de manipulation
Afin de garantir la disponibilit√© du domaine, j'ai activ√© la **protection contre la suppression accidentelle** sur les Unit√©s d'Organisation (OU) strat√©giques, notamment l'OU des contr√¥leurs de domaine. Cette mesure emp√™che toute suppression involontaire qui pourrait entra√Æner un arr√™t de service majeur.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/protected-ou.png" alt="ou non supprimables" class="max-w-[500px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Emp√™cher la suppression accidentelle d'une OU.</p>
  </div>
</div>

## Restriction du privil√®ge de jonction via Powershell (ms-DS-MachineAccountQuota)
Par d√©faut, n'importe quel utilisateur peut joindre 10 machines au domaine. C'est un risque majeur de d√©ni de service et d'usurpation. J'ai modifi√© cet attribut pour ramener le quota √† **0**, verrouillant ainsi la cr√©ation sauvage de comptes ordinateurs.

<div style="display: flex; justify-content: center; margin: 2rem 0;">
  <div style="display: flex; flex-direction: column; align-items: center; max-width: 500px;">
    <img src="/images/projets/win-infra-core/audit/ms-ds-desactived.png" alt="D√©sactivation quota machine" class="max-w-[400px] w-full rounded-lg border border-white/10 shadow-md" />
    <p class="text-[0.65rem] italic opacity-50 mt-2">Modification de l'attribut ms-DS-MachineAccountQuota pour interdire la jonction automatique.</p>
  </div>
</div>



---

## ‚úÖ Validation : Nouveau Scan

Apr√®s l'application de ces mesures, un second audit confirme une nette am√©lioration. Le score de la cat√©gorie **Anomalies** chute drastiquement, validant la disparition de NTLMv1 et du quota de machines.

La s√©curit√© √©tant un processus continu, les alertes restantes (comme la mise en place de LAPS ou la synchronisation NTP externe) seront trait√©es lors des prochaines phases de maintenance du projet.


## üöÄ Prochaines √©tapes : Vers une infrastructure durcie

Ce premier audit PingCastle a permis d'assainir les bases de l'Active Directory. 
Cependant, la s√©curisation d'une infrastructure est un processus continu. Les prochains chapitres de ce projet seront consacr√©s √† .... ?

<NextStep 
  href="/projets/ad-cs" 
  title="Installation de l‚ÄôAutorit√© de Certification (AD CS)" 
/>